<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AIoT AGV æˆ°è¡“æ§åˆ¶å° | å·¥æ¥­ç´šå¤šAGVå”åŒèª¿åº¦ç³»çµ±</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-dark: #0a0e27; --panel-dark: #161b33;
            --accent-green: #00ff88; --accent-red: #ff6b35; --accent-blue: #00aaff;
            --accent-yellow: #ffd700; --accent-purple: #aa00ff;
            --text-main: #e0f8f0; --text-dim: #8a9bb8;
        }
        body { 
            font-family: 'Segoe UI', 'Noto Sans TC', sans-serif; 
            background: var(--bg-dark); 
            color: var(--text-main); 
            min-height: 100vh; 
            padding: 10px; 
            -webkit-font-smoothing: antialiased; 
            background-image: radial-gradient(circle at 20% 30%, rgba(0, 100, 255, 0.05) 0%, transparent 20%),
                              radial-gradient(circle at 80% 70%, rgba(0, 255, 136, 0.05) 0%, transparent 20%);
        }
        .container { max-width: 1800px; margin: 0 auto; }
        
        /* é ‚éƒ¨æ¨™é¡Œå€ */
        .top-bar {
            display: grid;
            grid-template-columns: 2fr 1fr 2fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        .header-panel {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            padding: 15px 20px; 
            border-radius: 10px;
            border-left: 5px solid var(--accent-green);
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }
        h1 { 
            font-size: 1.8em; 
            color: var(--accent-green); 
            text-shadow: 0 0 10px rgba(0,255,136,0.3); 
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .subtitle { 
            color: var(--accent-blue); 
            font-size: 0.9em; 
            font-weight: 300;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .system-stats {
            display: flex;
            justify-content: space-around;
            align-items: center;
            height: 100%;
        }
        .stat-item {
            text-align: center;
        }
        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--accent-green);
        }
        .stat-label {
            font-size: 0.7em;
            color: var(--text-dim);
            margin-top: 2px;
        }
        
        /* ä¸»ç¶²æ ¼ä½ˆå±€ */
        .main-grid { 
            display: grid; 
            grid-template-columns: 320px 1fr 400px;
            gap: 15px; 
            height: calc(100vh - 150px);
        }
        
        /* é¢æ¿é€šç”¨æ¨£å¼ */
        .panel { 
            background: var(--panel-dark); 
            border: 1px solid rgba(42, 59, 85, 0.6); 
            border-radius: 8px; 
            padding: 20px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
            display: flex; 
            flex-direction: column; 
            backdrop-filter: blur(5px);
        }
        .panel-title { 
            color: var(--accent-green); 
            font-weight: bold; 
            font-size: 1.2em; 
            margin-bottom: 20px; 
            padding-bottom: 12px; 
            border-bottom: 2px solid rgba(0,255,136,0.3); 
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .panel-subtitle {
            color: var(--accent-blue);
            font-size: 0.85em;
            margin-top: -15px;
            margin-bottom: 15px;
        }
        
        /* åœ°åœ–å€åŸŸ */
        .map-container {
            position: relative;
            flex: 1;
        }
        canvas {
            width: 100%; 
            height: 100%; 
            background: #0b1016;
            border: 1px solid rgba(42, 59, 85, 0.8); 
            border-radius: 6px;
            cursor: crosshair;
        }
        .map-overlay {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(10, 14, 39, 0.8);
            border: 1px solid var(--accent-green);
            border-radius: 5px;
            padding: 10px;
            font-size: 0.8em;
        }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        .btn {
            width: 100%; 
            padding: 12px; 
            margin: 8px 0;
            background: linear-gradient(135deg, #1f2a40 0%, #2a3b55 100%);
            border: 1px solid var(--accent-green);
            color: var(--accent-green); 
            cursor: pointer; 
            border-radius: 6px;
            font-weight: bold; 
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn:hover {
            background: linear-gradient(135deg, var(--accent-green) 0%, #00cc77 100%);
            color: #000;
            box-shadow: 0 0 15px rgba(0,255,136,0.5);
            transform: translateY(-2px);
        }
        .btn:active { transform: translateY(1px); }
        .btn-danger { 
            border-color: var(--accent-red); 
            color: var(--accent-red);
            background: linear-gradient(135deg, rgba(255, 107, 53, 0.1) 0%, rgba(255, 107, 53, 0.05) 100%);
        }
        .btn-danger:hover {
            background: linear-gradient(135deg, var(--accent-red) 0%, #ff8c5a 100%);
            color: white;
        }
        .btn-warning { 
            border-color: var(--accent-yellow); 
            color: var(--accent-yellow);
        }
        .btn-warning:hover {
            background: linear-gradient(135deg, var(--accent-yellow) 0%, #ffea80 100%);
            color: #000;
        }
        .btn-secondary {
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }
        .btn-secondary:hover {
            background: linear-gradient(135deg, var(--accent-blue) 0%, #66ccff 100%);
            color: white;
        }
        
        /* AGVé¸æ“‡å™¨ */
        .agv-selector {
            margin-bottom: 20px;
        }
        .agv-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        .agv-card {
            background: rgba(26, 26, 46, 0.6);
            border: 2px solid #2a3b55;
            border-radius: 6px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .agv-card.active {
            border-color: var(--accent-green);
            background: rgba(0, 255, 136, 0.1);
        }
        .agv-card h4 {
            color: var(--accent-green);
            margin-bottom: 5px;
        }
        .agv-card .agv-stats {
            font-size: 0.75em;
            color: var(--text-dim);
        }
        
        /* åƒæ•¸æ§åˆ¶ */
        .param-group {
            margin-bottom: 20px;
            background: rgba(26, 26, 46, 0.4);
            padding: 15px;
            border-radius: 6px;
            border-left: 3px solid var(--accent-blue);
        }
        .param-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9em;
        }
        .param-name { color: var(--text-dim); }
        .param-value { color: var(--accent-green); font-weight: bold; }
        .param-bar { 
            height: 8px; 
            background: rgba(255, 255, 255, 0.1); 
            margin-top: 8px; 
            border-radius: 4px; 
            overflow: hidden; 
        }
        .param-bar-fill { 
            height: 100%; 
            background: linear-gradient(90deg, var(--accent-green), #00cc77); 
            transition: width 0.5s ease; 
            position: relative;
        }
        .param-bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: shine 2s infinite;
        }
        @keyframes shine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        /* ä»»å‹™éšŠåˆ— */
        .task-queue {
            background: rgba(11, 16, 22, 0.7);
            border: 1px solid rgba(42, 59, 85, 0.5);
            height: 150px;
            overflow-y: auto;
            border-radius: 6px;
            margin-top: 15px;
            padding: 10px;
        }
        .task-item {
            background: rgba(31, 42, 64, 0.5);
            border-left: 3px solid var(--accent-green);
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 4px;
            font-size: 0.8em;
            display: flex;
            justify-content: space-between;
        }
        .task-item.queued { border-color: var(--accent-yellow); }
        .task-item.completed { border-color: var(--accent-blue); opacity: 0.7; }
        
        /* æ—¥èªŒå®¹å™¨ */
        .log-container { 
            background: rgba(11, 16, 22, 0.8); 
            border: 1px solid rgba(42, 59, 85, 0.6); 
            height: 200px; 
            overflow-y: auto; 
            padding: 10px; 
            border-radius: 6px;
            margin-top: 15px;
            font-family: 'Consolas', 'Courier New', monospace; 
            font-size: 0.8em;
        }
        .log-entry { 
            margin-bottom: 6px; 
            border-left: 3px solid #555; 
            padding-left: 8px; 
            padding-top: 2px;
            padding-bottom: 2px;
            line-height: 1.4;
        }
        .log-entry:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 1400px) {
            .main-grid { grid-template-columns: 300px 1fr; }
            .right-panel { grid-column: span 2; }
            canvas { height: 500px; }
        }
        @media (max-width: 1024px) {
            .main-grid { grid-template-columns: 1fr; }
            canvas { height: 400px; }
            .top-bar { grid-template-columns: 1fr; }
        }
        
        /* å‹•æ…‹æŒ‡ç¤ºå™¨ */
        .led-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            box-shadow: 0 0 10px currentColor;
        }
        
        /* æ»‘å‹•æ¢ */
        .slider-container {
            margin: 15px 0;
        }
        .slider {
            width: 100%;
            height: 6px;
            background: #2a3b55;
            border-radius: 3px;
            outline: none;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        .slider:hover { opacity: 1; }
        
        /* åˆ†é æ¨™ç±¤ */
        .tab-container {
            margin: 15px 0;
        }
        .tab-header {
            display: flex;
            border-bottom: 1px solid #2a3b55;
        }
        .tab-button {
            padding: 10px 20px;
            background: transparent;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        .tab-button.active {
            color: var(--accent-green);
            border-bottom: 3px solid var(--accent-green);
        }
        .tab-content {
            padding: 15px 0;
        }
        .tab-panel {
            display: none;
        }
        .tab-panel.active {
            display: block;
        }
    </style>
</head>
<body>

<div class="container">
    <!-- é ‚éƒ¨è³‡è¨Šæ¬„ -->
    <div class="top-bar">
        <div class="header-panel">
            <h1>ğŸ¤– AIoT AGV æˆ°è¡“æ§åˆ¶å°</h1>
            <div class="subtitle">
                <span class="led-indicator" style="color:#00ff88;"></span>
                å·¥æ¥­ç´šå¤šAGVå”åŒèª¿åº¦ç³»çµ± | ç‰ˆæœ¬ 7.0
            </div>
        </div>
        
        <div class="header-panel" style="border-color:var(--accent-blue);">
            <div class="system-stats">
                <div class="stat-item">
                    <div class="stat-value" id="totalTasks">0</div>
                    <div class="stat-label">ç¸½ä»»å‹™æ•¸</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="activeVehicles">2</div>
                    <div class="stat-label">é‹è¡Œè»Šè¼›</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="systemUptime">00:00</div>
                    <div class="stat-label">ç³»çµ±é‹è¡Œæ™‚é–“</div>
                </div>
            </div>
        </div>
        
        <div class="header-panel" style="border-color:var(--accent-yellow);">
            <div style="display: flex; align-items: center; height: 100%;">
                <div style="flex: 1;">
                    <div style="color:var(--accent-yellow); font-weight:bold; font-size:0.9em;">ç³»çµ±ç‹€æ…‹</div>
                    <div id="systemStatus" style="color:var(--accent-green); font-weight:bold;">æ­£å¸¸é‹è¡Œ</div>
                </div>
                <div style="font-size: 2em; color: var(--accent-green);">
                    âš™ï¸
                </div>
            </div>
        </div>
    </div>
    
    <!-- ä¸»å…§å®¹å€ -->
    <div class="main-grid">
        <!-- å·¦å´æ§åˆ¶é¢æ¿ -->
        <div class="panel">
            <div class="panel-title">ğŸ“¡ AGV æ§åˆ¶ä¸­å¿ƒ</div>
            <div class="panel-subtitle">é¸æ“‡è»Šè¼›ä¸¦è¨­å®šä»»å‹™</div>
            
            <div class="agv-selector">
                <div class="agv-grid">
                    <div class="agv-card active" onclick="selectAGV('AGV-01')">
                        <h4>ğŸŸ¢ AGV-01</h4>
                        <div class="agv-stats">
                            <div>ç‹€æ…‹: <span id="status-01" style="color:#00ff88;">æº–å‚™ä¸­</span></div>
                            <div>é›»é‡: <span id="battery-01">100%</span></div>
                        </div>
                    </div>
                    <div class="agv-card" onclick="selectAGV('AGV-02')">
                        <h4>ğŸ”µ AGV-02</h4>
                        <div class="agv-stats">
                            <div>ç‹€æ…‹: <span id="status-02" style="color:#00ff88;">æº–å‚™ä¸­</span></div>
                            <div>é›»é‡: <span id="battery-02">92%</span></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tab-container">
                <div class="tab-header">
                    <button class="tab-button active" onclick="switchTab('mission')">ä»»å‹™</button>
                    <button class="tab-button" onclick="switchTab('navigation')">å°èˆª</button>
                    <button class="tab-button" onclick="switchTab('settings')">è¨­å®š</button>
                </div>
                
                <div class="tab-content">
                    <!-- ä»»å‹™åˆ†é  -->
                    <div id="mission-tab" class="tab-panel active">
                        <button class="btn" onclick="startContinuousMission()">
                            <span>âš¡</span> å•Ÿå‹•é€£çºŒä»»å‹™æ¨¡å¼
                        </button>
                        <button class="btn" onclick="addTaskToQueue()">
                            <span>â•</span> æ·»åŠ ç•¶å‰ç›®æ¨™åˆ°ä»»å‹™éšŠåˆ—
                        </button>
                        <button class="btn" onclick="executeTaskQueue()">
                            <span>ğŸš€</span> åŸ·è¡Œä»»å‹™éšŠåˆ—
                        </button>
                        <button class="btn" onclick="clearTaskQueue()">
                            <span>ğŸ—‘ï¸</span> æ¸…ç©ºä»»å‹™éšŠåˆ—
                        </button>
                        <button class="btn-secondary" onclick="generateRandomPatrol()">
                            <span>ğŸ”„</span> ç”Ÿæˆéš¨æ©Ÿå·¡é‚è·¯å¾‘
                        </button>
                    </div>
                    
                    <!-- å°èˆªåˆ†é  -->
                    <div id="navigation-tab" class="tab-panel">
                        <button class="btn" onclick="navigateToPoint('dock')">
                            <span>ğŸ”‹</span> å°èˆªè‡³å……é›»ç«™
                        </button>
                        <button class="btn" onclick="navigateToPoint('pickup')">
                            <span>ğŸ“¦</span> å°èˆªè‡³å–è²¨é»
                        </button>
                        <button class="btn" onclick="navigateToPoint('delivery')">
                            <span>ğŸ“¬</span> å°èˆªè‡³é€è²¨é»
                        </button>
                        <div style="margin: 15px 0; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 5px;">
                            <div style="font-size: 0.8em; color: var(--text-dim); margin-bottom: 5px;">æ‰‹å‹•åº§æ¨™è¼¸å…¥</div>
                            <input type="number" id="coordX" placeholder="Xåº§æ¨™" style="width:45%; padding:5px; margin-right:5px; background:#1a1a2e; color:white; border:1px solid #2a3b55; border-radius:3px;">
                            <input type="number" id="coordY" placeholder="Yåº§æ¨™" style="width:45%; padding:5px; background:#1a1a2e; color:white; border:1px solid #2a3b55; border-radius:3px;">
                            <button class="btn" style="padding:5px; margin-top:8px;" onclick="navigateToManual()">å°èˆª</button>
                        </div>
                    </div>
                    
                    <!-- è¨­å®šåˆ†é  -->
                    <div id="settings-tab" class="tab-panel">
                        <div class="slider-container">
                            <label style="color:var(--text-dim); font-size:0.9em;">æœ€å¤§é€Ÿåº¦é™åˆ¶</label>
                            <input type="range" min="1" max="20" value="10" class="slider" id="speedLimit">
                            <div style="text-align:right; font-size:0.8em; color:var(--accent-green);" id="speedValue">10 å–®ä½/ç§’</div>
                        </div>
                        <div class="slider-container">
                            <label style="color:var(--text-dim); font-size:0.9em;">å®‰å…¨è·é›¢</label>
                            <input type="range" min="10" max="100" value="30" class="slider" id="safetyDistance">
                            <div style="text-align:right; font-size:0.8em; color:var(--accent-green);" id="safetyValue">30 åƒç´ </div>
                        </div>
                        <button class="btn-warning" onclick="toggleCollisionAvoidance()">
                            <span>ğŸ›¡ï¸</span> åˆ‡æ›é˜²ç¢°æ’ç³»çµ±
                        </button>
                        <button class="btn" style="border-color:#555; color:#888;" onclick="resetSystem()">
                            <span>ğŸ”„</span> ç³»çµ±é‡ç½®
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="task-queue" id="taskQueue">
                <!-- ä»»å‹™éšŠåˆ—å…§å®¹å°‡ç”±JSå‹•æ…‹ç”Ÿæˆ -->
                <div style="text-align:center; color:var(--text-dim); padding:20px;">
                    <div style="font-size:1.5em;">ğŸ“‹</div>
                    ä»»å‹™éšŠåˆ—ç‚ºç©º
                </div>
            </div>
        </div>
        
        <!-- ä¸­é–“åœ°åœ–å€åŸŸ -->
        <div class="panel">
            <div class="panel-title">ğŸ—ºï¸ æˆ°è¡“åœ°åœ–ç³»çµ±</div>
            <div class="panel-subtitle">å³æ™‚ä½ç½®è¿½è¹¤èˆ‡è·¯å¾‘è¦åŠƒ</div>
            
            <div class="map-container">
                <canvas id="mapCanvas"></canvas>
                <div class="map-overlay">
                    <div>é»æ“Šåœ°åœ–è¨­å®šç›®æ¨™</div>
                    <div style="font-size:0.7em; color:#888;">Ctrl+é»æ“Š: æ·»åŠ è‡³ä»»å‹™éšŠåˆ—</div>
                </div>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-top: 15px;">
                <button class="btn-warning" onclick="sendCommand('PAUSE_ALL')">
                    <span>â¸ï¸</span> æš«åœæ‰€æœ‰AGV
                </button>
                <button class="btn-danger" onclick="sendCommand('ESTOP_ALL')">
                    <span>ğŸ›‘</span> å…¨éƒ¨ç·Šæ€¥åœæ­¢
                </button>
                <button class="btn-secondary" onclick="sendCommand('RESUME_ALL')">
                    <span>â–¶ï¸</span> æ¢å¾©æ‰€æœ‰AGV
                </button>
            </div>
        </div>
        
        <!-- å³å´ç›£æ§é¢æ¿ -->
        <div class="panel right-panel">
            <div class="panel-title">ğŸ“Š å³æ™‚ç›£æ§é¢æ¿</div>
            
            <div class="tab-container">
                <div class="tab-header">
                    <button class="tab-button active" onclick="switchMonitorTab('telemetry')">é™æ¸¬</button>
                    <button class="tab-button" onclick="switchMonitorTab('diagnostics')">è¨ºæ–·</button>
                    <button class="tab-button" onclick="switchMonitorTab('fleet')">è»ŠéšŠ</button>
                </div>
                
                <div class="tab-content">
                    <!-- é™æ¸¬åˆ†é  -->
                    <div id="telemetry-tab" class="tab-panel active">
                        <div class="param-group">
                            <div class="param-label">
                                <span class="param-name">ğŸŸ¢ ç•¶å‰AGVé€Ÿåº¦</span>
                                <span class="param-value" id="val-speed">0 å–®ä½/ç§’</span>
                            </div>
                            <div class="param-bar">
                                <div class="param-bar-fill" id="bar-speed" style="width:0%"></div>
                            </div>
                        </div>
                        
                        <div class="param-group">
                            <div class="param-label">
                                <span class="param-name">ğŸ”‹ é›»æ± é›»é‡</span>
                                <span class="param-value" id="val-bat">100%</span>
                            </div>
                            <div class="param-bar">
                                <div class="param-bar-fill" id="bar-bat" style="width:100%"></div>
                            </div>
                        </div>
                        
                        <div class="param-group">
                            <div class="param-label">
                                <span class="param-name">ğŸ“¡ LiDARè·é›¢</span>
                                <span class="param-value" id="val-lidar">--</span>
                            </div>
                            <div class="param-bar">
                                <div class="param-bar-fill" id="bar-lidar" style="width:0%"></div>
                            </div>
                        </div>
                        
                        <div class="param-group">
                            <div class="param-label">
                                <span class="param-name">ğŸ§­ èˆªå‘è§’åº¦</span>
                                <span class="param-value" id="val-heading">0Â°</span>
                            </div>
                            <input type="range" min="0" max="360" value="0" class="slider" id="headingSlider" oninput="updateHeading(this.value)">
                        </div>
                    </div>
                    
                    <!-- è¨ºæ–·åˆ†é  -->
                    <div id="diagnostics-tab" class="tab-panel">
                        <div style="color:var(--text-dim); font-size:0.9em; margin-bottom:10px;">ç³»çµ±è¨ºæ–·ç‹€æ…‹</div>
                        <div id="diagnosticsList">
                            <div class="diagnostic-item" style="padding:8px; margin-bottom:5px; border-left:3px solid #00ff88; background:rgba(0,255,136,0.1);">
                                âœ… å°èˆªç³»çµ±: æ­£å¸¸
                            </div>
                            <div class="diagnostic-item" style="padding:8px; margin-bottom:5px; border-left:3px solid #00ff88; background:rgba(0,255,136,0.1);">
                                âœ… é€šè¨Šç³»çµ±: æ­£å¸¸
                            </div>
                            <div class="diagnostic-item" style="padding:8px; margin-bottom:5px; border-left:3px solid #00ff88; background:rgba(0,255,136,0.1);">
                                âœ… é›»æºç³»çµ±: æ­£å¸¸
                            </div>
                        </div>
                        <button class="btn" style="margin-top:15px; padding:8px;" onclick="runDiagnostics()">
                            ğŸ” åŸ·è¡Œç³»çµ±è¨ºæ–·
                        </button>
                    </div>
                    
                    <!-- è»ŠéšŠåˆ†é  -->
                    <div id="fleet-tab" class="tab-panel">
                        <div style="font-size:0.9em; color:var(--text-dim); margin-bottom:10px;">è»ŠéšŠç‹€æ…‹æ¦‚è¦½</div>
                        <div id="fleetStatus">
                            <!-- è»ŠéšŠç‹€æ…‹å°‡ç”±JSå‹•æ…‹ç”Ÿæˆ -->
                        </div>
                        <button class="btn" style="margin-top:15px; padding:8px;" onclick="optimizeFleetRoutes()">
                            ğŸ§  æ™ºèƒ½è·¯ç·šå„ªåŒ–
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="log-container" id="logBox">
                <div class="log-entry" style="border-color:#00ff88;">[ç³»çµ±å•Ÿå‹•] AGVæˆ°è¡“æ§åˆ¶å°å·²å°±ç·’</div>
            </div>
        </div>
    </div>
</div>

<script>
// ========== ç³»çµ±é…ç½®èˆ‡å…¨åŸŸè®Šæ•¸ ==========
const CONFIG = {
    TARGET_THRESHOLD: 3.0,        // ç›®æ¨™åˆ°é”é–¾å€¼
    MIN_SPEED: 0.5,              // æœ€å°ç§»å‹•é€Ÿåº¦
    MAX_SPEED: 10.0,             // æœ€å¤§ç§»å‹•é€Ÿåº¦
    AUTO_MODE_INTERVAL: 2000,    // è‡ªå‹•æ¨¡å¼é–“éš”(ms)
    BATTERY_DRAIN_RATE: 0.002,   // é›»é‡æ¶ˆè€—ç‡
    COLLISION_RADIUS: 30,        // ç¢°æ’æª¢æ¸¬åŠå¾‘
    TASK_QUEUE_LIMIT: 20         // ä»»å‹™éšŠåˆ—æœ€å¤§é•·åº¦
};

// ç³»çµ±ç‹€æ…‹
let currentAGV = 'AGV-01';
let systemUptime = 0;
let totalTasksCompleted = 0;
let collisionAvoidanceEnabled = true;
let systemPaused = false;
let ctrlPressed = false;

// ä»»å‹™éšŠåˆ—ç³»çµ±
let taskQueues = {
    'AGV-01': [],
    'AGV-02': []
};

// è»ŠéšŠè³‡æ–™çµæ§‹ - æ›´è©³ç´°çš„çœŸå¯¦æ¨¡æ“¬
const fleet = {
    'AGV-01': {
        id: 'AGV-01',
        name: 'ç‰©æµå‹AGV-01',
        type: 'LOGISTICS',
        x: 50, y: 50,
        angle: 0,
        targetX: 50, targetY: 50,
        state: 'IDLE', // IDLE, MOVING, PAUSED, ESTOP, CHARGING, ERROR
        speed: 0,
        maxSpeed: CONFIG.MAX_SPEED,
        battery: 100,
        color: '#00ff88',
        path: [],
        lastTaskTime: 0,
        totalDistance: 0,
        tasksCompleted: 0,
        status: 'æº–å‚™ä¸­',
        efficiency: 95,
        collisionRisk: 0,
        telemetry: {
            temperature: 25.5,
            motorCurrent: 2.1,
            encoderCount: 0
        }
    },
    'AGV-02': {
        id: 'AGV-02',
        name: 'å·¡æª¢å‹AGV-02',
        type: 'INSPECTION',
        x: 100, y: 350,
        angle: -1.57,
        targetX: 100, targetY: 350,
        state: 'IDLE',
        speed: 0,
        maxSpeed: CONFIG.MAX_SPEED * 0.8,
        battery: 92,
        color: '#00aaff',
        path: [],
        lastTaskTime: 0,
        totalDistance: 0,
        tasksCompleted: 0,
        status: 'æº–å‚™ä¸­',
        efficiency: 92,
        collisionRisk: 0,
        telemetry: {
            temperature: 26.2,
            motorCurrent: 1.8,
            encoderCount: 0
        }
    }
};

// åœ°åœ–å…ƒç´ 
const obstacles = [
    {x: 250, y: 100, w: 50, h: 200, type: 'RACK'},
    {x: 600, y: 250, w: 150, h: 50, type: 'WORKSTATION'},
    {x: 400, y: 150, w: 30, h: 30, type: 'PILLAR'},
    {x: 100, y: 200, w: 80, h: 40, type: 'MACHINE'}
];

// é‡è¦ç«™é»
const stations = {
    dock: {x: 800, y: 50, type: 'DOCKING', name: 'å……é›»ç«™'},
    pickup: {x: 700, y: 400, type: 'PICKUP', name: 'å–è²¨é»'},
    delivery: {x: 100, y: 450, type: 'DELIVERY', name: 'é€è²¨é»'}
};

// è¦–è¦ºæ•ˆæœ
let clickEffects = [];
let pathPoints = [];
let lastUpdateTime = 0;

// ========== åˆå§‹åŒ–ç³»çµ± ==========
const canvas = document.getElementById('mapCanvas');
const ctx = canvas.getContext('2d');

function initSystem() {
    // åˆå§‹åŒ–ç•«å¸ƒ
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);
    
    // åˆå§‹åŒ–äº‹ä»¶ç›£è½å™¨
    initEventListeners();
    
    // å•Ÿå‹•ç³»çµ±è¨ˆæ™‚å™¨
    setInterval(updateSystemUptime, 1000);
    
    // å•Ÿå‹•è‡ªå‹•ä»»å‹™ç”Ÿæˆå™¨
    setInterval(autoTaskGenerator, 5000);
    
    // å•Ÿå‹•ä¸»è¦éŠæˆ²å¾ªç’°
    requestAnimationFrame(gameLoop);
    
    // æ›´æ–°UI
    updateAllUI();
    
    addLog('SYSTEM', 'INFO', 'ç³»çµ±åˆå§‹åŒ–å®Œæˆï¼Œç­‰å¾…æŒ‡ä»¤...');
}

function resizeCanvas() {
    const rect = canvas.getBoundingClientRect();
    const newWidth = Math.floor(rect.width);
    const newHeight = Math.floor(rect.height);
    
    if (canvas.width !== newWidth || canvas.height !== newHeight) {
        canvas.width = newWidth;
        canvas.height = newHeight;
    }
}

function initEventListeners() {
    // ç•«å¸ƒé»æ“Šäº‹ä»¶
    canvas.addEventListener('mousedown', (e) => {
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        const x = (e.clientX - rect.left) * scaleX;
        const y = (e.clientY - rect.top) * scaleY;
        
        if (e.ctrlKey || e.metaKey) {
            // Ctrl+é»æ“Šï¼šæ·»åŠ åˆ°ä»»å‹™éšŠåˆ—
            addTaskToQueue(currentAGV, x, y);
        } else {
            // æ™®é€šé»æ“Šï¼šç›´æ¥å°èˆª
            navigateAGV(currentAGV, x, y, true);
        }
    });
    
    // éµç›¤äº‹ä»¶
    document.addEventListener('keydown', (e) => {
        ctrlPressed = e.ctrlKey || e.metaKey;
    });
    
    document.addEventListener('keyup', (e) => {
        ctrlPressed = e.ctrlKey || e.metaKey;
    });
    
    // æ»‘å‹•æ¢äº‹ä»¶
    document.getElementById('speedLimit').addEventListener('input', (e) => {
        const value = e.target.value;
        document.getElementById('speedValue').textContent = value + ' å–®ä½/ç§’';
        fleet[currentAGV].maxSpeed = value * 1.0;
        addLog(currentAGV, 'CONFIG', `æœ€å¤§é€Ÿåº¦è¨­å®šç‚º: ${value}`);
    });
    
    document.getElementById('safetyDistance').addEventListener('input', (e) => {
        const value = e.target.value;
        document.getElementById('safetyValue').textContent = value + ' åƒç´ ';
        CONFIG.COLLISION_RADIUS = parseInt(value);
        addLog('SYSTEM', 'CONFIG', `å®‰å…¨è·é›¢è¨­å®šç‚º: ${value}`);
    });
    
    document.getElementById('headingSlider').addEventListener('input', (e) => {
        fleet[currentAGV].angle = (parseInt(e.target.value) * Math.PI) / 180;
    });
}

// ========== æ ¸å¿ƒAGVç§»å‹•é‚è¼¯ ==========
function updateAGVPhysics(agv, deltaTime) {
    if (agv.state !== 'MOVING' || systemPaused) return;
    
    // è¨ˆç®—åˆ°ç›®æ¨™çš„è·é›¢å’Œæ–¹å‘
    const dx = agv.targetX - agv.x;
    const dy = agv.targetY - agv.y;
    const distance = Math.sqrt(dx * dx + dy * dy);
    
    // æª¢æŸ¥æ˜¯å¦åˆ°é”ç›®æ¨™
    if (distance < CONFIG.TARGET_THRESHOLD) {
        handleArrivalAtTarget(agv);
        return;
    }
    
    // è¨ˆç®—ç›®æ¨™è§’åº¦
    let targetAngle = Math.atan2(dy, dx);
    
    // å¹³æ»‘è½‰å‘
    let angleDiff = targetAngle - agv.angle;
    while (angleDiff > Math.PI) angleDiff -= 2 * Math.PI;
    while (angleDiff < -Math.PI) angleDiff += 2 * Math.PI;
    
    agv.angle += angleDiff * 0.2; // è½‰å‘é€Ÿåº¦
    
    // è¨ˆç®—é€Ÿåº¦ï¼ˆåŸºæ–¼è·é›¢å‹•æ…‹èª¿æ•´ï¼‰
    let targetSpeed = 0;
    if (distance > 100) {
        targetSpeed = agv.maxSpeed;
    } else if (distance > 50) {
        targetSpeed = agv.maxSpeed * 0.7;
    } else if (distance > 20) {
        targetSpeed = agv.maxSpeed * 0.4;
    } else {
        targetSpeed = Math.max(CONFIG.MIN_SPEED, agv.maxSpeed * 0.2);
    }
    
    // LiDARé¿éšœæª¢æ¸¬
    const lidarDistance = getLidarDistance(agv);
    if (lidarDistance < 50) {
        targetSpeed *= (lidarDistance / 50);
    }
    if (lidarDistance < 20) {
        targetSpeed = 0;
        agv.state = 'PAUSED';
        addLog(agv.id, 'WARN', 'åµæ¸¬åˆ°éšœç¤™ç‰©ï¼Œæš«åœç§»å‹•');
    }
    
    // å¤šAGVé˜²ç¢°æ’
    if (collisionAvoidanceEnabled) {
        const collisionRisk = checkCollisionRisk(agv);
        if (collisionRisk > 0) {
            targetSpeed *= (1 - collisionRisk);
            agv.collisionRisk = collisionRisk;
        }
    }
    
    // å¥—ç”¨é€Ÿåº¦
    agv.speed = targetSpeed;
    
    // è¨ˆç®—ä½ç§»
    const moveDistance = agv.speed * (deltaTime / 16); // 16msåŸºæº–
    const moveX = Math.cos(agv.angle) * moveDistance;
    const moveY = Math.sin(agv.angle) * moveDistance;
    
    // é‚Šç•Œæª¢æŸ¥
    const newX = agv.x + moveX;
    const newY = agv.y + moveY;
    
    if (newX > 10 && newX < canvas.width - 10 && newY > 10 && newY < canvas.height - 10) {
        agv.x = newX;
        agv.y = newY;
        agv.totalDistance += moveDistance;
    }
    
    // æ›´æ–°è»Œè·¡
    if (Math.random() > 0.7) {
        agv.path.push({x: agv.x, y: agv.y});
        if (agv.path.length > 40) agv.path.shift();
    }
    
    // æ›´æ–°é›»é‡
    agv.battery -= CONFIG.BATTERY_DRAIN_RATE * agv.speed;
    if (agv.battery < 0) agv.battery = 0;
    
    // é›»é‡ä½æ™‚è‡ªå‹•è¿”å›å……é›»
    if (agv.battery < 15 && agv.state !== 'CHARGING') {
        addLog(agv.id, 'WARN', 'é›»é‡ä¸è¶³ï¼Œè‡ªå‹•è¿”å›å……é›»ç«™');
        navigateToStation(agv.id, 'dock');
    }
    
    // æ›´æ–°ç·¨ç¢¼å™¨è¨ˆæ•¸
    agv.telemetry.encoderCount += moveDistance * 10;
}

function handleArrivalAtTarget(agv) {
    agv.speed = 0;
    totalTasksCompleted++;
    agv.tasksCompleted++;
    
    // æ›´æ–°ä»»å‹™å®Œæˆæ™‚é–“
    agv.lastTaskTime = Date.now();
    
    // æª¢æŸ¥æ˜¯å¦æœ‰ä¸‹ä¸€å€‹ä»»å‹™
    if (taskQueues[agv.id].length > 0) {
        // åŸ·è¡Œä¸‹ä¸€å€‹ä»»å‹™
        const nextTask = taskQueues[agv.id].shift();
        agv.targetX = nextTask.x;
        agv.targetY = nextTask.y;
        agv.state = 'MOVING';
        updateTaskQueueDisplay();
        addLog(agv.id, 'TASK', `é–‹å§‹åŸ·è¡Œä¸‹ä¸€å€‹ä»»å‹™: (${Math.round(nextTask.x)}, ${Math.round(nextTask.y)})`);
    } else if (agv.state === 'MOVING') {
        // æ²’æœ‰æ›´å¤šä»»å‹™ï¼Œé€²å…¥IDLEç‹€æ…‹
        agv.state = 'IDLE';
        agv.status = 'é–’ç½®ä¸­';
        addLog(agv.id, 'TASK', 'æ‰€æœ‰ä»»å‹™å®Œæˆï¼Œé€²å…¥é–’ç½®ç‹€æ…‹');
    }
    
    // æ›´æ–°UI
    updateAllUI();
}

// ========== ä»»å‹™éšŠåˆ—ç³»çµ± ==========
function addTaskToQueue(agvId, x, y) {
    if (!agvId) agvId = currentAGV;
    if (!x || !y) {
        // ä½¿ç”¨ç•¶å‰ç›®æ¨™
        const agv = fleet[agvId];
        x = agv.targetX;
        y = agv.targetY;
    }
    
    if (taskQueues[agvId].length >= CONFIG.TASK_QUEUE_LIMIT) {
        addLog(agvId, 'ERROR', 'ä»»å‹™éšŠåˆ—å·²æ»¿ï¼Œç„¡æ³•æ·»åŠ æ–°ä»»å‹™');
        return;
    }
    
    const taskId = `TASK-${Date.now()}-${Math.floor(Math.random()*1000)}`;
    taskQueues[agvId].push({
        id: taskId,
        x: x,
        y: y,
        status: 'QUEUED',
        timestamp: Date.now()
    });
    
    updateTaskQueueDisplay();
    addLog(agvId, 'TASK', `ä»»å‹™æ·»åŠ åˆ°éšŠåˆ—: (${Math.round(x)}, ${Math.round(y)})`);
}

function executeTaskQueue(agvId) {
    if (!agvId) agvId = currentAGV;
    
    if (taskQueues[agvId].length === 0) {
        addLog(agvId, 'WARN', 'ä»»å‹™éšŠåˆ—ç‚ºç©º');
        return;
    }
    
    const agv = fleet[agvId];
    if (agv.state === 'ESTOP' || agv.state === 'ERROR') {
        addLog(agvId, 'ERROR', 'AGVç‹€æ…‹ç•°å¸¸ï¼Œç„¡æ³•åŸ·è¡Œä»»å‹™');
        return;
    }
    
    // é–‹å§‹åŸ·è¡Œç¬¬ä¸€å€‹ä»»å‹™
    const firstTask = taskQueues[agvId][0];
    agv.targetX = firstTask.x;
    agv.targetY = firstTask.y;
    agv.state = 'MOVING';
    agv.status = 'åŸ·è¡Œä»»å‹™ä¸­';
    
    addLog(agvId, 'TASK', `é–‹å§‹åŸ·è¡Œä»»å‹™éšŠåˆ— (${taskQueues[agvId].length}å€‹ä»»å‹™)`);
    updateAllUI();
}

function clearTaskQueue(agvId) {
    if (!agvId) agvId = currentAGV;
    taskQueues[agvId] = [];
    updateTaskQueueDisplay();
    addLog(agvId, 'TASK', 'ä»»å‹™éšŠåˆ—å·²æ¸…ç©º');
}

function updateTaskQueueDisplay() {
    const queueDiv = document.getElementById('taskQueue');
    const agvId = currentAGV;
    const tasks = taskQueues[agvId];
    
    if (tasks.length === 0) {
        queueDiv.innerHTML = `
            <div style="text-align:center; color:var(--text-dim); padding:20px;">
                <div style="font-size:1.5em;">ğŸ“‹</div>
                ä»»å‹™éšŠåˆ—ç‚ºç©º
            </div>
        `;
        return;
    }
    
    let html = '';
    tasks.forEach((task, index) => {
        const statusClass = task.status === 'COMPLETED' ? 'completed' : 
                          task.status === 'EXECUTING' ? 'executing' : 'queued';
        html += `
            <div class="task-item ${statusClass}">
                <div>
                    <strong>ä»»å‹™ ${index+1}</strong><br>
                    <span style="font-size:0.8em;">(${Math.round(task.x)}, ${Math.round(task.y)})</span>
                </div>
                <div style="font-size:0.7em; color:#888;">
                    ${task.status === 'QUEUED' ? 'ç­‰å¾…ä¸­' : 'åŸ·è¡Œä¸­'}
                </div>
            </div>
        `;
    });
    
    queueDiv.innerHTML = html;
    document.getElementById('totalTasks').textContent = tasks.length;
}

// ========== å°èˆªèˆ‡æ§åˆ¶å‡½æ•¸ ==========
function navigateAGV(agvId, x, y, direct = true) {
    const agv = fleet[agvId];
    
    if (agv.state === 'ESTOP') {
        addLog(agvId, 'ERROR', 'ç·Šæ€¥åœæ­¢ä¸­ï¼Œç„¡æ³•ç§»å‹•');
        return;
    }
    
    if (direct) {
        // ç›´æ¥å°èˆªï¼Œæ¸…é™¤ç¾æœ‰ä»»å‹™éšŠåˆ—
        taskQueues[agvId] = [];
    }
    
    agv.targetX = x;
    agv.targetY = y;
    agv.state = 'MOVING';
    agv.status = 'å°èˆªä¸­';
    
    // è¦–è¦ºæ•ˆæœ
    clickEffects.push({
        x: x, y: y, 
        r: 0, maxR: 40, 
        color: agv.color,
        life: 1.0
    });
    
    addLog(agvId, 'NAV', `å°èˆªè‡³: (${Math.round(x)}, ${Math.round(y)})`);
    updateAllUI();
}

function navigateToStation(agvId, stationType) {
    const station = stations[stationType];
    if (!station) {
        addLog(agvId, 'ERROR', `æœªçŸ¥çš„ç«™é»é¡å‹: ${stationType}`);
        return;
    }
    
    navigateAGV(agvId, station.x, station.y);
    addLog(agvId, 'NAV', `å°èˆªè‡³${station.name}`);
}

function startContinuousMission() {
    // ç‚ºå…©å°AGVéƒ½å•Ÿå‹•é€£çºŒä»»å‹™
    for (const agvId in fleet) {
        const agv = fleet[agvId];
        if (agv.state !== 'ESTOP' && agv.state !== 'ERROR') {
            // æ¸…ç©ºç¾æœ‰éšŠåˆ—
            taskQueues[agvId] = [];
            
            // ç”Ÿæˆ5å€‹éš¨æ©Ÿä»»å‹™
            for (let i = 0; i < 5; i++) {
                const x = Math.random() * (canvas.width - 100) + 50;
                const y = Math.random() * (canvas.height - 100) + 50;
                taskQueues[agvId].push({
                    id: `CONT-${Date.now()}-${i}`,
                    x: x,
                    y: y,
                    status: 'QUEUED',
                    timestamp: Date.now()
                });
            }
            
            // é–‹å§‹åŸ·è¡Œ
            agv.state = 'MOVING';
            agv.status = 'é€£çºŒä»»å‹™ä¸­';
            
            // è¨­å®šç¬¬ä¸€å€‹ç›®æ¨™
            if (taskQueues[agvId].length > 0) {
                const firstTask = taskQueues[agvId][0];
                agv.targetX = firstTask.x;
                agv.targetY = firstTask.y;
            }
        }
    }
    
    updateTaskQueueDisplay();
    addLog('SYSTEM', 'MISSION', 'å•Ÿå‹•é€£çºŒä»»å‹™æ¨¡å¼');
}

function generateRandomPatrol() {
    const agv = fleet[currentAGV];
    const centerX = agv.x;
    const centerY = agv.y;
    
    // æ¸…ç©ºç¾æœ‰éšŠåˆ—
    taskQueues[currentAGV] = [];
    
    // ç”Ÿæˆå·¡é‚è·¯å¾‘ï¼ˆåœ“å½¢ï¼‰
    const radius = 150;
    const points = 8;
    
    for (let i = 0; i < points; i++) {
        const angle = (i / points) * Math.PI * 2;
        const x = centerX + Math.cos(angle) * radius;
        const y = centerY + Math.sin(angle) * radius;
        
        // ç¢ºä¿é»åœ¨ç•«å¸ƒå…§
        const boundedX = Math.max(50, Math.min(canvas.width - 50, x));
        const boundedY = Math.max(50, Math.min(canvas.height - 50, y));
        
        taskQueues[currentAGV].push({
            id: `PATROL-${i}`,
            x: boundedX,
            y: boundedY,
            status: 'QUEUED',
            timestamp: Date.now()
        });
    }
    
    // æ·»åŠ è¿”å›èµ·é»çš„ä»»å‹™
    taskQueues[currentAGV].push({
        id: 'PATROL-RETURN',
        x: centerX,
        y: centerY,
        status: 'QUEUED',
        timestamp: Date.now()
    });
    
    updateTaskQueueDisplay();
    addLog(currentAGV, 'PATROL', 'ç”Ÿæˆå·¡é‚è·¯å¾‘ (8å€‹é»)');
}

// ========== æ„Ÿæ¸¬å™¨èˆ‡æª¢æ¸¬å‡½æ•¸ ==========
function getLidarDistance(agv) {
    let minDistance = 500; // æœ€å¤§åµæ¸¬è·é›¢
    
    // æª¢æŸ¥éšœç¤™ç‰©
    obstacles.forEach(obstacle => {
        // ç°¡å–®çš„çŸ©å½¢ç¢°æ’æª¢æ¸¬
        const closestX = Math.max(obstacle.x, Math.min(agv.x, obstacle.x + obstacle.w));
        const closestY = Math.max(obstacle.y, Math.min(agv.y, obstacle.y + obstacle.h));
        
        const dx = agv.x - closestX;
        const dy = agv.y - closestY;
        const distance = Math.sqrt(dx * dx + dy * dy);
        
        if (distance < minDistance) {
            minDistance = distance;
        }
    });
    
    // æª¢æŸ¥å…¶ä»–AGV
    for (const otherId in fleet) {
        if (otherId !== agv.id) {
            const otherAGV = fleet[otherId];
            const dx = agv.x - otherAGV.x;
            const dy = agv.y - otherAGV.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            
            if (distance < minDistance) {
                minDistance = distance;
            }
        }
    }
    
    return Math.max(0, minDistance - 15); // æ¸›å»AGVåŠå¾‘
}

function checkCollisionRisk(agv) {
    let risk = 0;
    
    for (const otherId in fleet) {
        if (otherId !== agv.id) {
            const otherAGV = fleet[otherId];
            const dx = agv.x - otherAGV.x;
            const dy = agv.y - otherAGV.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            
            if (distance < CONFIG.COLLISION_RADIUS * 2) {
                // è¨ˆç®—ç¢°æ’é¢¨éšª (0åˆ°1)
                risk = Math.max(risk, 1 - (distance / (CONFIG.COLLISION_RADIUS * 2)));
            }
        }
    }
    
    return risk;
}

// ========== ç¹ªåœ–å‡½æ•¸ ==========
function draw() {
    if (canvas.width === 0 || canvas.height === 0) return;
    
    // æ¸…ç©ºç•«å¸ƒ
    ctx.fillStyle = '#0b1016';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // ç¹ªè£½ç¶²æ ¼
    drawGrid();
    
    // ç¹ªè£½ç«™é»
    drawStations();
    
    // ç¹ªè£½éšœç¤™ç‰©
    drawObstacles();
    
    // ç¹ªè£½AGVè»Œè·¡
    for (const agvId in fleet) {
        drawAGVPath(fleet[agvId]);
    }
    
    // ç¹ªè£½AGV
    for (const agvId in fleet) {
        drawAGV(fleet[agvId]);
    }
    
    // ç¹ªè£½ç›®æ¨™é»
    for (const agvId in fleet) {
        const agv = fleet[agvId];
        if (agv.state === 'MOVING') {
            drawTarget(agv);
        }
    }
    
    // ç¹ªè£½é»æ“Šæ•ˆæœ
    drawClickEffects();
    
    // ç¹ªè£½è·¯å¾‘é»
    drawPathPoints();
}

function drawGrid() {
    ctx.strokeStyle = 'rgba(42, 59, 85, 0.3)';
    ctx.lineWidth = 1;
    
    // ä¸»è¦ç¶²æ ¼ç·š
    for (let x = 0; x < canvas.width; x += 50) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, canvas.height);
        ctx.stroke();
    }
    for (let y = 0; y < canvas.height; y += 50) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(canvas.width, y);
        ctx.stroke();
    }
    
    // åº§æ¨™è»¸
    ctx.strokeStyle = 'rgba(0, 255, 136, 0.5)';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(0, canvas.height - 20);
    ctx.lineTo(canvas.width, canvas.height - 20);
    ctx.stroke();
    
    ctx.beginPath();
    ctx.moveTo(20, 0);
    ctx.lineTo(20, canvas.height);
    ctx.stroke();
}

function drawStations() {
    for (const key in stations) {
        const station = stations[key];
        ctx.fillStyle = station.type === 'DOCKING' ? 'rgba(0, 255, 136, 0.3)' :
                       station.type === 'PICKUP' ? 'rgba(255, 215, 0, 0.3)' :
                       'rgba(0, 170, 255, 0.3)';
        
        ctx.beginPath();
        ctx.arc(station.x, station.y, 25, 0, Math.PI * 2);
        ctx.fill();
        
        ctx.strokeStyle = station.type === 'DOCKING' ? '#00ff88' :
                         station.type === 'PICKUP' ? '#ffd700' :
                         '#00aaff';
        ctx.lineWidth = 2;
        ctx.stroke();
        
        ctx.fillStyle = 'white';
        ctx.font = '12px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(station.name, station.x, station.y + 40);
    }
}

function drawObstacles() {
    obstacles.forEach(obstacle => {
        ctx.fillStyle = obstacle.type === 'RACK' ? '#2a3b55' :
                       obstacle.type === 'WORKSTATION' ? '#3a4b65' :
                       '#4a5b75';
        ctx.fillRect(obstacle.x, obstacle.y, obstacle.w, obstacle.h);
        
        ctx.strokeStyle = '#556677';
        ctx.lineWidth = 2;
        ctx.strokeRect(obstacle.x, obstacle.y, obstacle.w, obstacle.h);
        
        // éšœç¤™ç‰©æ¨™ç±¤
        ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
        ctx.font = '10px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(
            obstacle.type, 
            obstacle.x + obstacle.w / 2, 
            obstacle.y + obstacle.h / 2
        );
    });
}

function drawAGV(agv) {
    // å„²å­˜ç•«å¸ƒç‹€æ…‹
    ctx.save();
    
    // ç§»å‹•åˆ°AGVä½ç½®ä¸¦æ—‹è½‰
    ctx.translate(agv.x, agv.y);
    ctx.rotate(agv.angle);
    
    // ç¹ªè£½æ„Ÿæ‡‰ç¯„åœ
    ctx.fillStyle = agv.color + '15';
    ctx.beginPath();
    ctx.arc(0, 0, 50, 0, Math.PI * 2);
    ctx.fill();
    
    // ç¹ªè£½è»Šèº«
    ctx.fillStyle = agv.color;
    ctx.fillRect(-15, -12, 30, 24);
    
    // ç¹ªè£½å‰å¾Œå€åˆ†
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(10, -8, 5, 16); // å‰ç‡ˆ
    
    ctx.fillStyle = '#ff4444';
    ctx.fillRect(-15, -8, 5, 16); // å°¾ç‡ˆ
    
    // ç¹ªè£½é ‚éƒ¨æŒ‡ç¤ºå™¨
    ctx.fillStyle = agv.state === 'MOVING' ? '#00ff88' :
                   agv.state === 'ESTOP' ? '#ff4444' :
                   agv.state === 'CHARGING' ? '#ffaa00' : '#888888';
    ctx.beginPath();
    ctx.arc(0, -18, 5, 0, Math.PI * 2);
    ctx.fill();
    
    // æ¢å¾©ç•«å¸ƒç‹€æ…‹
    ctx.restore();
    
    // ç¹ªè£½AGVè³‡è¨Š
    ctx.fillStyle = agv.color;
    ctx.font = 'bold 12px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(agv.id, agv.x, agv.y - 30);
    
    // ç‹€æ…‹æ¨™ç±¤
    ctx.fillStyle = agv.state === 'MOVING' ? '#00ff88' :
                   agv.state === 'ESTOP' ? '#ff4444' : '#aaaaaa';
    ctx.font = '10px Arial';
    ctx.fillText(agv.state, agv.x, agv.y + 35);
    
    // é›»é‡æŒ‡ç¤º
    const batteryWidth = 30;
    const batteryHeight = 8;
    const batteryX = agv.x - batteryWidth / 2;
    const batteryY = agv.y + 45;
    
    ctx.strokeStyle = '#666666';
    ctx.lineWidth = 1;
    ctx.strokeRect(batteryX, batteryY, batteryWidth, batteryHeight);
    
    const fillWidth = (agv.battery / 100) * batteryWidth;
    ctx.fillStyle = agv.battery > 30 ? '#00ff88' : 
                   agv.battery > 15 ? '#ffaa00' : '#ff4444';
    ctx.fillRect(batteryX, batteryY, fillWidth, batteryHeight);
}

function drawAGVPath(agv) {
    if (agv.path.length < 2) return;
    
    ctx.strokeStyle = agv.color + '80';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(agv.path[0].x, agv.path[0].y);
    
    for (let i = 1; i < agv.path.length; i++) {
        ctx.lineTo(agv.path[i].x, agv.path[i].y);
    }
    
    ctx.stroke();
}

function drawTarget(agv) {
    // ç›®æ¨™é»
    ctx.fillStyle = agv.color;
    ctx.beginPath();
    ctx.arc(agv.targetX, agv.targetY, 6, 0, Math.PI * 2);
    ctx.fill();
    
    // ç›®æ¨™æŒ‡ç¤ºç·š
    ctx.strokeStyle = agv.color + '80';
    ctx.lineWidth = 1;
    ctx.setLineDash([5, 5]);
    ctx.beginPath();
    ctx.moveTo(agv.x, agv.y);
    ctx.lineTo(agv.targetX, agv.targetY);
    ctx.stroke();
    ctx.setLineDash([]);
    
    // ç›®æ¨™è·é›¢æ¨™ç¤º
    const dx = agv.targetX - agv.x;
    const dy = agv.targetY - agv.y;
    const distance = Math.sqrt(dx * dx + dy * dy);
    
    ctx.fillStyle = 'white';
    ctx.font = '10px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(`${Math.round(distance)}px`, agv.targetX, agv.targetY - 15);
}

function drawClickEffects() {
    for (let i = clickEffects.length - 1; i >= 0; i--) {
        const effect = clickEffects[i];
        
        ctx.strokeStyle = effect.color;
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.arc(effect.x, effect.y, effect.r, 0, Math.PI * 2);
        ctx.stroke();
        
        effect.r += 1.5;
        effect.life -= 0.02;
        
        if (effect.r > effect.maxR || effect.life <= 0) {
            clickEffects.splice(i, 1);
        }
    }
}

function drawPathPoints() {
    pathPoints.forEach(point => {
        ctx.fillStyle = point.color + '40';
        ctx.beginPath();
        ctx.arc(point.x, point.y, 5, 0, Math.PI * 2);
        ctx.fill();
    });
}

// ========== ç³»çµ±æ§åˆ¶å‡½æ•¸ ==========
function sendCommand(command) {
    switch (command) {
        case 'ESTOP_ALL':
            for (const agvId in fleet) {
                fleet[agvId].state = 'ESTOP';
                fleet[agvId].status = 'ç·Šæ€¥åœæ­¢';
                fleet[agvId].speed = 0;
            }
            addLog('SYSTEM', 'EMERGENCY', 'æ‰€æœ‰AGVç·Šæ€¥åœæ­¢');
            break;
            
        case 'PAUSE_ALL':
            systemPaused = true;
            for (const agvId in fleet) {
                if (fleet[agvId].state === 'MOVING') {
                    fleet[agvId].state = 'PAUSED';
                    fleet[agvId].status = 'å·²æš«åœ';
                }
            }
            addLog('SYSTEM', 'CONTROL', 'æ‰€æœ‰AGVå·²æš«åœ');
            break;
            
        case 'RESUME_ALL':
            systemPaused = false;
            for (const agvId in fleet) {
                if (fleet[agvId].state === 'PAUSED') {
                    fleet[agvId].state = 'MOVING';
                    fleet[agvId].status = 'æ¢å¾©é‹è¡Œ';
                }
            }
            addLog('SYSTEM', 'CONTROL', 'æ‰€æœ‰AGVæ¢å¾©é‹è¡Œ');
            break;
    }
    
    updateAllUI();
}

function resetSystem() {
    // é‡ç½®æ‰€æœ‰AGVç‹€æ…‹
    fleet['AGV-01'] = {
        id: 'AGV-01',
        name: 'ç‰©æµå‹AGV-01',
        type: 'LOGISTICS',
        x: 50, y: 50,
        angle: 0,
        targetX: 50, targetY: 50,
        state: 'IDLE',
        speed: 0,
        maxSpeed: CONFIG.MAX_SPEED,
        battery: 100,
        color: '#00ff88',
        path: [],
        lastTaskTime: 0,
        totalDistance: 0,
        tasksCompleted: 0,
        status: 'æº–å‚™ä¸­',
        efficiency: 95,
        collisionRisk: 0,
        telemetry: {
            temperature: 25.5,
            motorCurrent: 2.1,
            encoderCount: 0
        }
    };
    
    fleet['AGV-02'] = {
        id: 'AGV-02',
        name: 'å·¡æª¢å‹AGV-02',
        type: 'INSPECTION',
        x: 100, y: 350,
        angle: -1.57,
        targetX: 100, targetY: 350,
        state: 'IDLE',
        speed: 0,
        maxSpeed: CONFIG.MAX_SPEED * 0.8,
        battery: 92,
        color: '#00aaff',
        path: [],
        lastTaskTime: 0,
        totalDistance: 0,
        tasksCompleted: 0,
        status: 'æº–å‚™ä¸­',
        efficiency: 92,
        collisionRisk: 0,
        telemetry: {
            temperature: 26.2,
            motorCurrent: 1.8,
            encoderCount: 0
        }
    };
    
    // æ¸…ç©ºä»»å‹™éšŠåˆ—
    taskQueues = {
        'AGV-01': [],
        'AGV-02': []
    };
    
    // é‡ç½®ç³»çµ±ç‹€æ…‹
    systemPaused = false;
    totalTasksCompleted = 0;
    
    // æ›´æ–°UI
    updateAllUI();
    updateTaskQueueDisplay();
    
    addLog('SYSTEM', 'RESET', 'ç³»çµ±å·²é‡ç½®');
}

function toggleCollisionAvoidance() {
    collisionAvoidanceEnabled = !collisionAvoidanceEnabled;
    const status = collisionAvoidanceEnabled ? 'å•Ÿç”¨' : 'åœç”¨';
    addLog('SYSTEM', 'SAFETY', `é˜²ç¢°æ’ç³»çµ± ${status}`);
    updateAllUI();
}

function updateHeading(value) {
    fleet[currentAGV].angle = (parseInt(value) * Math.PI) / 180;
    document.getElementById('val-heading').textContent = value + 'Â°';
}

// ========== UIæ›´æ–°å‡½æ•¸ ==========
function updateAllUI() {
    const agv = fleet[currentAGV];
    
    // æ›´æ–°AGVç‹€æ…‹
    document.getElementById(`status-${agv.id.split('-')[1]}`).textContent = agv.status;
    document.getElementById(`battery-${agv.id.split('-')[1]}`).textContent = Math.floor(agv.battery) + '%';
    
    // æ›´æ–°é™æ¸¬è³‡æ–™
    document.getElementById('val-speed').textContent = agv.speed.toFixed(1) + ' å–®ä½/ç§’';
    document.getElementById('bar-speed').style.width = (agv.speed / agv.maxSpeed * 100) + '%';
    
    document.getElementById('val-bat').textContent = Math.floor(agv.battery) + '%';
    document.getElementById('bar-bat').style.width = agv.battery + '%';
    
    const lidarDist = getLidarDistance(agv);
    document.getElementById('val-lidar').textContent = Math.floor(lidarDist) + ' åƒç´ ';
    document.getElementById('bar-lidar').style.width = Math.min(100, (lidarDist / 200 * 100)) + '%';
    
    document.getElementById('val-heading').textContent = Math.round((agv.angle * 180) / Math.PI) + 'Â°';
    document.getElementById('headingSlider').value = Math.round((agv.angle * 180) / Math.PI);
    
    // æ›´æ–°è»ŠéšŠç‹€æ…‹
    updateFleetStatus();
    
    // æ›´æ–°ç³»çµ±ç‹€æ…‹
    document.getElementById('activeVehicles').textContent = Object.values(fleet).filter(a => a.state === 'MOVING').length;
}

function updateFleetStatus() {
    const fleetDiv = document.getElementById('fleetStatus');
    let html = '';
    
    for (const agvId in fleet) {
        const agv = fleet[agvId];
        const stateColor = agv.state === 'MOVING' ? '#00ff88' :
                          agv.state === 'ESTOP' ? '#ff4444' :
                          agv.state === 'IDLE' ? '#ffaa00' : '#888888';
        
        html += `
            <div style="margin-bottom:10px; padding:10px; background:rgba(31,42,64,0.5); border-radius:5px; border-left:4px solid ${stateColor};">
                <div style="display:flex; justify-content:space-between;">
                    <strong>${agv.id}</strong>
                    <span style="color:${stateColor};">${agv.state}</span>
                </div>
                <div style="font-size:0.8em; color:var(--text-dim); margin-top:5px;">
                    é›»é‡: ${Math.floor(agv.battery)}% | 
                    é€Ÿåº¦: ${agv.speed.toFixed(1)} | 
                    è·é›¢: ${Math.floor(agv.totalDistance)}
                </div>
            </div>
        `;
    }
    
    fleetDiv.innerHTML = html;
}

function updateSystemUptime() {
    systemUptime++;
    const minutes = Math.floor(systemUptime / 60);
    const seconds = systemUptime % 60;
    document.getElementById('systemUptime').textContent = 
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

// ========== å·¥å…·å‡½æ•¸ ==========
function selectAGV(agvId) {
    currentAGV = agvId;
    
    // æ›´æ–°AGVå¡ç‰‡ç‹€æ…‹
    document.querySelectorAll('.agv-card').forEach(card => {
        card.classList.remove('active');
    });
    
    const card = document.querySelector(`.agv-card:nth-child(${agvId === 'AGV-01' ? 1 : 2})`);
    if (card) card.classList.add('active');
    
    // æ›´æ–°ä»»å‹™éšŠåˆ—é¡¯ç¤º
    updateTaskQueueDisplay();
    
    // æ›´æ–°UI
    updateAllUI();
    
    addLog(agvId, 'SELECT', 'é¸ä¸­æ­¤AGVé€²è¡Œæ§åˆ¶');
}

function switchTab(tabName) {
    // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
    document.querySelectorAll('#mission-tab, #navigation-tab, #settings-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // å•Ÿç”¨é¸ä¸­çš„åˆ†é 
    document.getElementById(`${tabName}-tab`).classList.add('active');
    document.querySelector(`.tab-button[onclick*="${tabName}"]`).classList.add('active');
}

function switchMonitorTab(tabName) {
    // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
    document.querySelectorAll('#telemetry-tab, #diagnostics-tab, #fleet-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelectorAll('.right-panel .tab-button').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // å•Ÿç”¨é¸ä¸­çš„åˆ†é 
    document.getElementById(`${tabName}-tab`).classList.add('active');
    document.querySelector(`.right-panel .tab-button[onclick*="${tabName}"]`).classList.add('active');
}

function addLog(source, type, message) {
    const logBox = document.getElementById('logBox');
    const entry = document.createElement('div');
    entry.className = 'log-entry';
    
    // è¨­å®šæ—¥èªŒé¡è‰²
    let color = '#00ff88'; // é è¨­ç¶ è‰²
    if (type === 'ERROR') color = '#ff6b35';
    else if (type === 'WARN') color = '#ffaa00';
    else if (type === 'NAV') color = '#00aaff';
    else if (type === 'TASK') color = '#aa00ff';
    else if (type === 'EMERGENCY') color = '#ff4444';
    
    entry.style.borderColor = color;
    
    // æ ¼å¼åŒ–æ™‚é–“
    const now = new Date();
    const timeStr = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
    
    entry.innerHTML = `[${timeStr}] <strong>${source}</strong>: ${message}`;
    
    // æ·»åŠ åˆ°æ—¥èªŒé ‚éƒ¨
    logBox.insertBefore(entry, logBox.firstChild);
    
    // é™åˆ¶æ—¥èªŒæ•¸é‡
    if (logBox.children.length > 50) {
        logBox.removeChild(logBox.lastChild);
    }
}

function runDiagnostics() {
    addLog('SYSTEM', 'DIAG', 'é–‹å§‹ç³»çµ±è¨ºæ–·...');
    
    // æ¨¡æ“¬è¨ºæ–·éç¨‹
    setTimeout(() => {
        addLog('SYSTEM', 'DIAG', 'è¨ºæ–·å®Œæˆ: æ‰€æœ‰ç³»çµ±æ­£å¸¸');
        
        // æ›´æ–°è¨ºæ–·ç‹€æ…‹
        document.getElementById('diagnosticsList').innerHTML = `
            <div class="diagnostic-item" style="padding:8px; margin-bottom:5px; border-left:3px solid #00ff88; background:rgba(0,255,136,0.1);">
                âœ… å°èˆªç³»çµ±: æ­£å¸¸ (ç²¾åº¦: 99.2%)
            </div>
            <div class="diagnostic-item" style="padding:8px; margin-bottom:5px; border-left:3px solid #00ff88; background:rgba(0,255,136,0.1);">
                âœ… é€šè¨Šç³»çµ±: æ­£å¸¸ (å»¶é²: 12ms)
            </div>
            <div class="diagnostic-item" style="padding:8px; margin-bottom:5px; border-left:3px solid #00ff88; background:rgba(0,255,136,0.1);">
                âœ… é›»æºç³»çµ±: æ­£å¸¸ (é›»å£“: 24.2V)
            </div>
            <div class="diagnostic-item" style="padding:8px; margin-bottom:5px; border-left:3px solid #00ff88; background:rgba(0,255,136,0.1);">
                âœ… æ„Ÿæ¸¬å™¨ç³»çµ±: æ­£å¸¸ (LiDAR: åœ¨ç·š)
            </div>
            <div class="diagnostic-item" style="padding:8px; margin-bottom:5px; border-left:3px solid #00ff88; background:rgba(0,255,136,0.1);">
                âœ… æ§åˆ¶ç³»çµ±: æ­£å¸¸ (éŸ¿æ‡‰: å„ªè‰¯)
            </div>
        `;
    }, 1000);
}

function optimizeFleetRoutes() {
    addLog('SYSTEM', 'OPTIMIZE', 'é–‹å§‹æ™ºèƒ½è·¯ç·šå„ªåŒ–...');
    
    // ç°¡å–®çš„è·¯ç·šå„ªåŒ–é‚è¼¯
    let optimizedCount = 0;
    
    for (const agvId in fleet) {
        if (taskQueues[agvId].length > 1) {
            // ç°¡å–®å„ªåŒ–ï¼šæŒ‰è·é›¢æ’åºä»»å‹™
            const agv = fleet[agvId];
            taskQueues[agvId].sort((a, b) => {
                const distA = Math.sqrt(Math.pow(a.x - agv.x, 2) + Math.pow(a.y - agv.y, 2));
                const distB = Math.sqrt(Math.pow(b.x - agv.x, 2) + Math.pow(b.y - agv.y, 2));
                return distA - distB;
            });
            
            optimizedCount++;
        }
    }
    
    updateTaskQueueDisplay();
    addLog('SYSTEM', 'OPTIMIZE', `è·¯ç·šå„ªåŒ–å®Œæˆï¼Œå„ªåŒ–äº†${optimizedCount}å°AGVçš„è·¯ç·š`);
}

function autoTaskGenerator() {
    // è‡ªå‹•ç‚ºé–’ç½®çš„AGVç”Ÿæˆä»»å‹™
    for (const agvId in fleet) {
        const agv = fleet[agvId];
        
        // å¦‚æœAGVé–’ç½®ä¸”é›»é‡å……è¶³ï¼Œè‡ªå‹•ç”Ÿæˆä»»å‹™
        if (agv.state === 'IDLE' && agv.battery > 20 && Math.random() > 0.7) {
            const x = Math.random() * (canvas.width - 100) + 50;
            const y = Math.random() * (canvas.height - 100) + 50;
            
            addTaskToQueue(agvId, x, y);
            
            // å¦‚æœæ²’æœ‰æ­£åœ¨åŸ·è¡Œçš„ä»»å‹™ï¼Œé–‹å§‹åŸ·è¡Œ
            if (agv.state === 'IDLE') {
                executeTaskQueue(agvId);
            }
        }
    }
}

// ========== ä¸»è¦éŠæˆ²å¾ªç’° ==========
function gameLoop(timestamp) {
    // è¨ˆç®—æ™‚é–“å¢é‡
    const deltaTime = lastUpdateTime ? timestamp - lastUpdateTime : 16;
    lastUpdateTime = timestamp;
    
    // æ›´æ–°æ‰€æœ‰AGVç‰©ç†ç‹€æ…‹
    if (!systemPaused) {
        for (const agvId in fleet) {
            updateAGVPhysics(fleet[agvId], deltaTime);
        }
    }
    
    // æ›´æ–°è¦–è¦ºæ•ˆæœ
    updateVisualEffects();
    
    // ç¹ªè£½å ´æ™¯
    draw();
    
    // æ›´æ–°UI
    updateAllUI();
    
    // è«‹æ±‚ä¸‹ä¸€å¹€
    requestAnimationFrame(gameLoop);
}

function updateVisualEffects() {
    // æ›´æ–°é»æ“Šæ•ˆæœ
    clickEffects.forEach(effect => {
        effect.r += 1.5;
        effect.life -= 0.02;
    });
    
    // ç§»é™¤å·²çµæŸçš„æ•ˆæœ
    clickEffects = clickEffects.filter(effect => effect.r <= effect.maxR && effect.life > 0);
}

// ========== å•Ÿå‹•ç³»çµ± ==========
window.addEventListener('load', initSystem);

// å°èˆªè¼”åŠ©å‡½æ•¸
function navigateToPoint(pointType) {
    navigateToStation(currentAGV, pointType);
}

function navigateToManual() {
    const x = parseInt(document.getElementById('coordX').value);
    const y = parseInt(document.getElementById('coordY').value);
    
    if (isNaN(x) || isNaN(y)) {
        addLog(currentAGV, 'ERROR', 'è«‹è¼¸å…¥æœ‰æ•ˆçš„åº§æ¨™');
        return;
    }
    
    navigateAGV(currentAGV, x, y, true);
}
</script>
</body>
</html>